{% extends "base.html" %}
{% from "macros.jinja" import window_vars with context %}

{% block scripts %}
{{ window_vars(user) }}
<script src="{{ static_url_for('devicetimer/static', path='js/index.js') }}"></script>
{% endblock %}

{% block styles %}
<style>
    /* Cards */
    .stat-card {
        border-radius: 8px;
    }

    .avatar_style {
        border-radius: 8px;
    }

    .custom_border {
        border: 1px solid rgba(128, 128, 128, 0.15) !important;
    }

    .custom_select .q-field__control {
        border-radius: 8px !important;
    }

    .search-input .q-field__control {
        border-radius: 8px !important;
        height: 36px;
    }

    .search-input .q-field__native {
        padding-top: 0;
        padding-bottom: 0;
    }

    .search-input .q-field__marginal {
        height: 36px;
    }

    /* Table */
    .table-border-soft .q-table__bottom,
    .table-border-soft td,
    .table-border-soft th,
    .table-border-soft thead,
    .table-border-soft tr {
        border-color: rgba(128, 128, 128, 0.15) !important;
    }

    .table-border-soft th {
        font-weight: 500;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    /* Dialog */
    .dialog_style {
        border-radius: 12px;
    }

    /* Info Box */
    .info-box .q-expansion-item {
        border-top: 1px solid rgba(128, 128, 128, 0.12);
    }

    .info-box .q-expansion-item:first-of-type {
        border-top: none;
    }

    /* Form Sections */
    .form-section {
        padding: 12px 0;
        border-bottom: 1px solid rgba(128, 128, 128, 0.12);
    }

    .form-section:first-of-type {
        padding-top: 0;
    }

    .form-section:last-of-type {
        border-bottom: none;
        padding-bottom: 0;
    }

    .form-section__title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.6;
        margin-bottom: 12px;
    }

    /* Switch Card */
    .switch-card {
        background: rgba(128, 128, 128, 0.05);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid rgba(128, 128, 128, 0.1);
    }

    .switch-card:last-child {
        margin-bottom: 0;
    }

    /* Stat Card Item */
    .stat-item {
        padding: 12px 16px;
    }

    .stat-label {
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        opacity: 0.7;
        margin-bottom: 2px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1.2;
    }

    /* Actions spacing */
    .action-btn {
        width: 32px;
        height: 32px;
    }

    /* QR Code Dialog */
    .qr-wrapper {
        background: white;
        border-radius: 12px;
        padding: 20px;
        display: inline-block;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .qr-image {
        width: 240px;
        height: 240px;
        display: block;
    }

    .lnurl-box {
        background: rgba(128, 128, 128, 0.06);
        border-radius: 8px;
        padding: 12px;
        border: 1px solid rgba(128, 128, 128, 0.1);
    }

    .lnurl-value {
        font-family: monospace;
        font-size: 0.7rem;
        word-break: break-all;
        color: var(--q-primary);
        line-height: 1.4;
        max-height: 60px;
        overflow-y: auto;
    }

    /* WebSocket Dialog */
    .ws-url-box {
        background: rgba(128, 128, 128, 0.06);
        border-radius: 8px;
        padding: 14px;
        border: 1px solid rgba(128, 128, 128, 0.12);
    }

    .ws-url-value {
        font-family: 'Roboto Mono', monospace;
        font-size: 0.8rem;
        word-break: break-all;
        color: var(--q-primary);
        line-height: 1.5;
        display: block;
    }

    /* Info Banner */
    .info-banner-wrapper {
        position: relative;
        width: 100%;
        height: 140px;
        overflow: hidden;
        border-radius: 8px 8px 0 0;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    .info-banner {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        transition: transform 0.3s ease;
    }

    .info-banner-wrapper:hover .info-banner {
        transform: scale(1.02);
    }

    .info-banner-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(to top, rgba(0,0,0,0.4) 0%, transparent 100%);
        pointer-events: none;
    }
</style>
{% endblock %}

{% block page %}
<div class="row q-col-gutter-md">

    <!-- Main Content -->
    <div class="col-12">

        <!-- Wallet Selector + Actions -->
        <div class="row items-center q-mb-md">
            <div class="col-auto">
                <q-select
                    v-model="selectedWallet"
                    :options="walletsWithCount"
                    option-value="id"
                    option-label="name"
                    class="custom_select"
                    emit-value
                    map-options
                    borderless
                    dense
                    filled
                    style="min-width: 200px;"
                    @update:model-value="onWalletChange"
                >
                    <template v-slot:prepend>
                        <q-icon color="primary" size="20px">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                    <path d="M17 8V5a1 1 0 0 0-1-1H6a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1-1 1H6a2 2 0 0 1-2-2V6"/>
                                    <path d="M20 12v4h-4a2 2 0 0 1 0-4z"/>
                                </g>
                            </svg>
                        </q-icon>
                    </template>
                    <template v-slot:option="scope">
                        <q-item v-bind="scope.itemProps">
                            <q-item-section>
                                <q-item-label>{% raw %}{{ scope.opt.name }}{% endraw %}</q-item-label>
                            </q-item-section>
                            <q-item-section side v-if="scope.opt.deviceCount > 0">
                                <q-badge color="primary" :label="scope.opt.deviceCount" />
                            </q-item-section>
                        </q-item>
                    </template>
                    <template v-slot:selected-item="scope">
                        <div class="row items-center no-wrap">
                            <span>{% raw %}{{ scope.opt.name }}{% endraw %}</span>
                            <q-badge v-if="scope.opt.deviceCount > 0" color="primary" class="q-ml-sm" :label="scope.opt.deviceCount" />
                        </div>
                    </template>
                </q-select>
            </div>
            <q-space></q-space>
            <div class="col-auto">
                <q-btn flat round size="sm" @click="drawerRight = true">
                    <q-icon name="info" size="20px" color="grey-7"></q-icon>
                    <q-tooltip>About</q-tooltip>
                </q-btn>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row q-col-gutter-sm q-mb-md">
            <div class="col-4">
                <q-card class="stat-card custom_border" flat>
                    <div class="row items-center stat-item">
                        <div class="col">
                            <div class="stat-label">Devices</div>
                            <div class="stat-value">{% raw %}{{ stats.totalDevices }}{% endraw %}</div>
                        </div>
                        <div class="col-auto">
                            <q-avatar size="36px" square class="bg-primary avatar_style text-white">
                                <q-icon size="18px">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2zm6 12h2"/>
                                    </svg>
                                </q-icon>
                            </q-avatar>
                        </div>
                    </div>
                </q-card>
            </div>
            <div class="col-4">
                <q-card class="stat-card custom_border" flat>
                    <div class="row items-center stat-item">
                        <div class="col">
                            <div class="stat-label">Switches</div>
                            <div class="stat-value text-primary">{% raw %}{{ stats.totalSwitches }}{% endraw %}</div>
                        </div>
                        <div class="col-auto">
                            <q-avatar size="36px" square class="bg-primary avatar_style text-white">
                                <q-icon size="18px">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M9 12l2 2l4-4M3 5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                    </svg>
                                </q-icon>
                            </q-avatar>
                        </div>
                    </div>
                </q-card>
            </div>
            <div class="col-4">
                <q-card class="stat-card custom_border" flat>
                    <div class="row items-center stat-item">
                        <div class="col">
                            <div class="row items-center">
                                <div class="col">
                                    <div class="stat-label">Connected</div>
                                    <div class="stat-value text-positive">{% raw %}{{ stats.activeSwitches }}{% endraw %}</div>
                                </div>
                                <q-separator vertical class="q-mx-sm" style="height: 32px; opacity: 0.2;"></q-separator>
                                <div class="col">
                                    <div class="stat-label">Offline</div>
                                    <div class="stat-value text-grey-6">{% raw %}{{ stats.inactiveSwitches }}{% endraw %}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-auto">
                            <q-avatar size="36px" square :class="stats.activeSwitches > 0 ? 'bg-positive' : 'bg-grey-5'" class="avatar_style text-white">
                                <q-icon size="18px">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                            <path d="M12 18v-6"/>
                                            <path d="M8 18v-2"/>
                                            <path d="M16 18v-4"/>
                                            <path d="M6 12a6 6 0 0 1 12 0"/>
                                            <path d="M3 9a10 10 0 0 1 18 0"/>
                                        </g>
                                    </svg>
                                </q-icon>
                            </q-avatar>
                        </div>
                    </div>
                </q-card>
            </div>
        </div>

        <!-- Devices Card -->
        <q-card class="stat-card custom_border" flat>
            <!-- Header -->
            <div class="row items-center q-px-md q-pt-md q-pb-sm">
                <div class="col">
                    <div class="text-subtitle1 text-weight-medium">Timed Devices</div>
                    <div class="text-caption text-grey">Manage your bitcoinSwitch devices</div>
                </div>
                <div class="col-auto row items-center q-gutter-x-sm">
                    <q-input
                        v-model="filter"
                        outlined
                        dense
                        debounce="300"
                        placeholder="Search..."
                        class="search-input"
                        style="width: 160px;"
                    >
                        <template v-slot:prepend>
                            <q-icon name="search" size="16px" color="grey-6"></q-icon>
                        </template>
                    </q-input>
                    <q-btn flat round size="sm" @click="exportCSV">
                        <q-icon size="18px">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M14 3v4a1 1 0 0 0 1 1h4M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2M12 11v6m-3-3l3 3l3-3"/>
                            </svg>
                        </q-icon>
                        <q-tooltip>Export CSV</q-tooltip>
                    </q-btn>
                    <q-btn unelevated color="primary" size="sm" class="avatar_style" @click="openDeviceDialog()" no-caps>
                        <q-icon name="add" size="18px" class="q-mr-xs"></q-icon>
                        New Device
                    </q-btn>
                </div>
            </div>

            <!-- Empty State - No devices at all -->
            <div v-if="!loading && devices.length === 0" class="text-center" style="padding: 64px 24px;">
                <q-icon size="72px" color="grey-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 24 24">
                        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2zm6 12h2"/>
                    </svg>
                </q-icon>
                <div class="text-h5 q-mt-lg">Welcome to DeviceTimer</div>
                <div class="text-body1 text-grey-7 q-mt-sm" style="max-width: 400px; margin: 0 auto;">
                    Turn your physical devices into Bitcoin-powered machines with time-based controls.
                </div>
                <div class="text-body2 text-grey-6 q-mt-md q-mb-xl" style="max-width: 380px; margin-left: auto; margin-right: auto;">
                    Set operating hours, cooldown periods, and daily limits. Perfect for animal feeding machines, vending machines, arcade games, or any IoT device.
                </div>
                <q-btn unelevated color="primary" size="md" class="avatar_style q-px-lg" @click="openDeviceDialog()" no-caps>
                    <q-icon name="add" size="20px" class="q-mr-sm"></q-icon>
                    Create Your First Device
                </q-btn>
            </div>

            <!-- Empty State - Wallet has no devices -->
            <div v-else-if="!loading && filteredDevices.length === 0 && selectedWallet !== 'all'" class="text-center" style="padding: 56px 24px;">
                <q-icon size="56px" color="grey-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="56" height="56" viewBox="0 0 24 24">
                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5">
                            <path d="M17 8V5a1 1 0 0 0-1-1H6a2 2 0 0 0 0 4h12a1 1 0 0 1 1 1v3m0 4v3a1 1 0 0 1-1 1H6a2 2 0 0 1-2-2V6"/>
                            <path d="M20 12v4h-4a2 2 0 0 1 0-4z"/>
                        </g>
                    </svg>
                </q-icon>
                <div class="text-h6 q-mt-lg">No Devices Yet</div>
                <div class="text-body2 text-grey-7 q-mt-sm q-mb-xl" style="max-width: 320px; margin-left: auto; margin-right: auto;">
                    This wallet has no timed devices configured. Add one to start accepting Lightning payments.
                </div>
                <q-btn unelevated color="primary" class="avatar_style q-px-md" @click="openDeviceDialog()" no-caps>
                    <q-icon name="add" size="18px" class="q-mr-sm"></q-icon>
                    Add Device
                </q-btn>
            </div>

            <!-- Empty State - Search has no results -->
            <div v-else-if="!loading && filteredDevices.length === 0 && filter" class="text-center" style="padding: 48px 24px;">
                <q-icon size="48px" color="grey-4" name="search_off"></q-icon>
                <div class="text-subtitle1 q-mt-lg">No Results</div>
                <div class="text-body2 text-grey-7 q-mt-sm q-mb-lg">
                    No devices found for "<strong>{% raw %}{{ filter }}{% endraw %}</strong>"
                </div>
                <q-btn flat color="primary" @click="filter = ''" no-caps>Clear Search</q-btn>
            </div>

            <!-- Devices Table -->
            <q-table
                v-else
                flat
                :rows="filteredDevices"
                :columns="deviceColumns"
                row-key="id"
                :loading="loading"
                class="table-border-soft"
                :pagination="{rowsPerPage: 10}"
                hide-bottom
            >
                <template v-slot:body-cell-id="props">
                    <q-td :props="props">
                        <div class="row items-center no-wrap">
                            <code class="text-caption text-grey-7" style="font-size: 0.7rem;">{% raw %}{{ props.row.id.substring(0, 8) }}...{% endraw %}</code>
                            <q-btn flat dense round size="xs" color="grey-6" class="q-ml-xs" @click="copyText(props.row.id, 'Device ID copied!')">
                                <q-icon size="14px">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24">
                                        <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                            <path d="M7 9.667A2.667 2.667 0 0 1 9.667 7h8.666A2.667 2.667 0 0 1 21 9.667v8.666A2.667 2.667 0 0 1 18.333 21H9.667A2.667 2.667 0 0 1 7 18.333z"/>
                                            <path d="M4.012 16.737A2 2 0 0 1 3 15V5c0-1.1.9-2 2-2h10c.75 0 1.158.385 1.5 1"/>
                                        </g>
                                    </svg>
                                </q-icon>
                                <q-tooltip>Copy full ID</q-tooltip>
                            </q-btn>
                        </div>
                    </q-td>
                </template>

                <template v-slot:body-cell-title="props">
                    <q-td :props="props">
                        <div class="row items-center no-wrap">
                            <span>{% raw %}{{ props.row.title }}{% endraw %}</span>
                            <q-badge
                                v-if="isDeviceLive(props.row.id)"
                                color="positive"
                                class="q-ml-sm"
                                rounded
                            >
                                <q-icon name="wifi" size="12px" class="q-mr-xs"></q-icon>
                                Live
                            </q-badge>
                        </div>
                    </q-td>
                </template>

                <template v-slot:body-cell-hours="props">
                    <q-td :props="props">
                        <q-badge color="blue-grey-7" class="q-px-sm q-py-xs">
                            {% raw %}{{ formatHours(props.row) }}{% endraw %}
                        </q-badge>
                    </q-td>
                </template>

                <template v-slot:body-cell-switches="props">
                    <q-td :props="props">
                        <q-badge color="primary" class="q-px-sm q-py-xs">
                            {% raw %}{{ props.row.switches?.length || 0 }}{% endraw %}
                        </q-badge>
                    </q-td>
                </template>

                <template v-slot:body-cell-actions="props">
                    <q-td :props="props" class="q-gutter-x-xs">
                        <q-btn
                            flat
                            dense
                            round
                            size="sm"
                            color="grey-7"
                            @click="openQrCodeDialog(props.row)"
                            :disable="protocol === 'http:' || !props.row.switches?.length"
                        >
                            <q-icon size="18px">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 4m0 1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1zm10 0m0 1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1zm-10 10m0 1a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v4a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1zM17 14v3m0 3v.01M14 17h3"/>
                                </svg>
                            </q-icon>
                            <q-tooltip v-if="protocol === 'http:'">LNURLs require HTTPS</q-tooltip>
                            <q-tooltip v-else-if="!props.row.switches?.length">No switches configured</q-tooltip>
                            <q-tooltip v-else>View QR Codes</q-tooltip>
                        </q-btn>

                        <q-btn flat dense round size="sm" color="primary" @click="openWebsocketDialog(props.row)">
                            <q-icon size="18px">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                    <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                        <path d="M12 18v-6"/>
                                        <path d="M8 18v-2"/>
                                        <path d="M16 18v-4"/>
                                        <path d="M6 12a6 6 0 0 1 12 0"/>
                                        <path d="M3 9a10 10 0 0 1 18 0"/>
                                    </g>
                                </svg>
                            </q-icon>
                            <q-tooltip>Device Connection</q-tooltip>
                        </q-btn>

                        <q-btn flat dense round size="sm" color="grey-7" @click="openDeviceDialog(props.row)">
                            <q-icon size="18px">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                    <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                        <path d="M7 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-1"/>
                                        <path d="M20.385 6.585a2.1 2.1 0 0 0-2.97-2.97L9 12v3h3zM16 5l3 3"/>
                                    </g>
                                </svg>
                            </q-icon>
                            <q-tooltip>Edit</q-tooltip>
                        </q-btn>

                        <q-btn flat dense round size="sm" color="red-7" @click="deleteDevice(props.row.id)">
                            <q-icon size="18px">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24">
                                    <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M4 7h16m-10 4v6m4-6v6M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"/>
                                </svg>
                            </q-icon>
                            <q-tooltip>Delete</q-tooltip>
                        </q-btn>
                    </q-td>
                </template>
            </q-table>
        </q-card>
    </div>

    <!-- Info Drawer -->
    <q-drawer v-model="drawerRight" side="right" bordered overlay :width="320">
        <div class="q-pa-md">
            <div class="row items-center q-mb-lg">
                <div class="col text-h6">About</div>
                <div class="col-auto">
                    <q-btn flat round dense size="sm" @click="drawerRight = false">
                        <q-icon name="close" size="18px"></q-icon>
                    </q-btn>
                </div>
            </div>

            <q-card class="info-box custom_border" flat>
                <div class="info-banner-wrapper">
                    <img
                        src="{{ static_url_for('devicetimer/static', path='image/DeviceTimer_Banner.png') }}"
                        class="info-banner"
                    >
                    <div class="info-banner-overlay"></div>
                </div>

                <!-- Description -->
                <q-card-section class="q-pb-sm">
                    <div class="text-subtitle1 text-weight-bold q-mb-sm">DeviceTimer</div>
                    <p class="text-body2 text-grey-7 q-mb-sm" style="line-height: 1.5;">
                        Bring your physical devices to life with Bitcoin Lightning payments.
                    </p>
                    <p class="text-caption text-grey-6 q-mb-none" style="line-height: 1.5;">
                        DeviceTimer extends the bitcoinSwitch ecosystem with powerful time-based controls.
                        Set operating hours, enforce cooldown periods, and limit daily usage.
                        Perfect for animal feeders, arcade machines, vending machines, and any IoT device.
                    </p>
                </q-card-section>

                <!-- Features -->
                <q-expansion-item
                    dense
                    header-class="text-weight-medium"
                    expand-icon-class="text-grey-6"
                >
                    <template v-slot:header>
                        <q-item-section avatar style="min-width: 32px;">
                            <q-icon name="stars" size="18px" color="primary"></q-icon>
                        </q-item-section>
                        <q-item-section class="text-body2">Features</q-item-section>
                    </template>
                    <q-card-section class="q-pt-none q-pb-md q-pl-lg">
                        <div class="row q-col-gutter-y-sm">
                            <div class="col-12 row items-center">
                                <q-icon name="schedule" size="16px" color="grey-5" class="q-mr-sm"></q-icon>
                                <span class="text-caption text-grey-8">Operating hours control</span>
                            </div>
                            <div class="col-12 row items-center">
                                <q-icon name="timer" size="16px" color="grey-5" class="q-mr-sm"></q-icon>
                                <span class="text-caption text-grey-8">Timeout between triggers</span>
                            </div>
                            <div class="col-12 row items-center">
                                <q-icon name="event_repeat" size="16px" color="grey-5" class="q-mr-sm"></q-icon>
                                <span class="text-caption text-grey-8">Daily trigger limits</span>
                            </div>
                            <div class="col-12 row items-center">
                                <q-icon name="image" size="16px" color="grey-5" class="q-mr-sm"></q-icon>
                                <span class="text-caption text-grey-8">Custom status images</span>
                            </div>
                        </div>
                    </q-card-section>
                </q-expansion-item>

                <!-- Resources -->
                <q-expansion-item
                    dense
                    header-class="text-weight-medium"
                    expand-icon-class="text-grey-6"
                >
                    <template v-slot:header>
                        <q-item-section avatar style="min-width: 32px;">
                            <q-icon name="link" size="18px" color="primary"></q-icon>
                        </q-item-section>
                        <q-item-section class="text-body2">Resources</q-item-section>
                    </template>
                    <q-card-section class="q-pt-none q-pb-md q-pl-lg">
                        <q-btn
                            outline
                            color="primary"
                            size="sm"
                            class="full-width avatar_style"
                            no-caps
                            @click="openDocumentation()"
                        >
                            <q-icon name="menu_book" size="16px" class="q-mr-sm"></q-icon>
                            Documentation & Setup Guide
                        </q-btn>
                    </q-card-section>
                </q-expansion-item>

                <!-- Support -->
                <q-expansion-item
                    dense
                    header-class="text-weight-medium"
                    expand-icon-class="text-grey-6"
                >
                    <template v-slot:header>
                        <q-item-section avatar style="min-width: 32px;">
                            <q-icon name="favorite" size="18px" color="pink-5"></q-icon>
                        </q-item-section>
                        <q-item-section class="text-body2">Support Us</q-item-section>
                    </template>
                    <q-card-section class="q-pt-none q-pb-md q-pl-lg">
                        <p class="text-caption text-grey-7 q-mb-sm" style="line-height: 1.5;">
                            DeviceTimer is free and open source. Your donations help us maintain and improve the extension.
                        </p>
                        <q-btn
                            unelevated
                            color="pink-5"
                            text-color="white"
                            size="sm"
                            class="full-width avatar_style"
                            no-caps
                            @click="openDonationDialog"
                        >
                            <q-icon name="bolt" size="16px" class="q-mr-sm"></q-icon>
                            Donate via Lightning
                        </q-btn>
                    </q-card-section>
                </q-expansion-item>

                <!-- Credits -->
                <q-expansion-item
                    dense
                    header-class="text-weight-medium"
                    expand-icon-class="text-grey-6"
                >
                    <template v-slot:header>
                        <q-item-section avatar style="min-width: 32px;">
                            <q-icon name="people" size="18px" color="grey-6"></q-icon>
                        </q-item-section>
                        <q-item-section class="text-body2">Credits</q-item-section>
                    </template>
                    <q-card-section class="q-pt-none q-pb-md q-pl-lg">
                        <div class="text-caption text-grey-7" style="line-height: 1.6;">
                            <div class="q-mb-xs">
                                <span class="text-weight-medium text-grey-8">Developed by</span><br>
                                <a href="https://github.com/pieterjm" target="_blank" class="text-primary">Pieterjm</a>,
                                <a href="https://github.com/DoktorShift" target="_blank" class="text-primary">DrShift</a> &
                                <a href="https://business-bitcoin.de" target="_blank" class="text-primary">Business-Bitcoin</a>
                            </div>
                            <div>
                                <span class="text-weight-medium text-grey-8">Based on LNURLDevice by</span><br>
                                <a href="https://github.com/arcbtc" target="_blank" class="text-primary">Ben Arc</a>,
                                <a href="https://github.com/blackcoffeexbt" target="_blank" class="text-primary">BlackCoffee</a>,
                                <a href="https://github.com/motorina0" target="_blank" class="text-primary">motorina0</a>,
                                <a href="https://github.com/dni" target="_blank" class="text-primary">dni</a>
                            </div>
                        </div>
                    </q-card-section>
                </q-expansion-item>
            </q-card>
        </div>
    </q-drawer>

    <!-- Device Dialog -->
    <q-dialog v-model="deviceDialog.show" persistent>
        <q-card class="dialog_style" style="width: 520px; max-width: 95vw;">
            <q-card-section class="q-pb-none">
                <div class="row items-center no-wrap">
                    <div class="col">
                        <div class="text-h6">{% raw %}{{ deviceDialog.isEdit ? 'Edit Device' : 'New Device' }}{% endraw %}</div>
                    </div>
                    <div class="col-auto">
                        <q-btn outline round dense size="sm" color="grey-5" @click="deviceDialog.show = false">
                            <q-icon name="close" size="18px"></q-icon>
                        </q-btn>
                    </div>
                </div>
            </q-card-section>

            <q-card-section class="q-pt-md">
                <q-form @submit="submitDeviceForm">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <div class="form-section__title">Basic Information</div>
                        <q-input
                            v-model="deviceDialog.data.title"
                            filled
                            dense
                            label="Device Name *"
                            :rules="[val => !!val || 'Required']"
                            class="q-mb-sm"
                        ></q-input>

                        <q-select
                            v-model="deviceDialog.data.wallet"
                            :options="g.user.wallets"
                            option-value="id"
                            option-label="name"
                            emit-value
                            map-options
                            filled
                            dense
                            label="Wallet *"
                            class="q-mb-sm"
                        ></q-select>

                        <div class="row q-col-gutter-sm">
                            <div class="col-6">
                                <q-select
                                    v-model="deviceDialog.data.currency"
                                    :options="currencies"
                                    filled
                                    dense
                                    label="Currency"
                                ></q-select>
                            </div>
                            <div class="col-6">
                                <q-select
                                    v-model="deviceDialog.data.timezone"
                                    :options="timezones"
                                    filled
                                    dense
                                    label="Timezone"
                                    use-input
                                    input-debounce="300"
                                    @filter="(val, update) => update(() => {})"
                                ></q-select>
                            </div>
                        </div>
                    </div>

                    <!-- Schedule -->
                    <div class="form-section">
                        <div class="form-section__title">Operating Schedule</div>
                        <div class="row q-col-gutter-sm q-mb-sm">
                            <div class="col-6">
                                <q-input
                                    v-model="deviceDialog.data.available_start"
                                    filled
                                    dense
                                    label="Opening Time"
                                    mask="##:##"
                                    hint="HH:MM"
                                ></q-input>
                            </div>
                            <div class="col-6">
                                <q-input
                                    v-model="deviceDialog.data.available_stop"
                                    filled
                                    dense
                                    label="Closing Time"
                                    mask="##:##"
                                    hint="HH:MM"
                                ></q-input>
                            </div>
                        </div>
                        <div class="row q-col-gutter-sm">
                            <div class="col-6">
                                <q-input
                                    v-model.number="deviceDialog.data.timeout"
                                    type="number"
                                    filled
                                    dense
                                    label="Timeout (sec)"
                                    hint="Cooldown"
                                ></q-input>
                            </div>
                            <div class="col-6">
                                <q-input
                                    v-model.number="deviceDialog.data.maxperday"
                                    type="number"
                                    filled
                                    dense
                                    label="Max/Day"
                                    hint="0 = unlimited"
                                ></q-input>
                            </div>
                        </div>
                    </div>

                    <!-- Status Images -->
                    <div class="form-section">
                        <div class="form-section__title">Status Images</div>
                        <q-input
                            v-model="deviceDialog.data.closed_url"
                            filled
                            dense
                            label="Closed Image URL"
                            hint="Shown outside operating hours"
                            class="q-mb-sm"
                        ></q-input>
                        <q-input
                            v-model="deviceDialog.data.wait_url"
                            filled
                            dense
                            label="Wait Image URL"
                            hint="Shown during timeout"
                        ></q-input>
                    </div>

                    <!-- Switches -->
                    <div class="form-section">
                        <div class="row items-center q-mb-sm">
                            <div class="col form-section__title q-mb-none">Switches</div>
                            <div class="col-auto">
                                <q-btn round dense flat size="sm" color="primary" icon="add" @click="addSwitch">
                                    <q-tooltip>Add Switch</q-tooltip>
                                </q-btn>
                            </div>
                        </div>

                        <div v-if="deviceDialog.data.switches.length === 0" class="text-center text-grey-6 q-py-md text-caption">
                            No switches configured
                        </div>

                        <div v-for="(sw, index) in deviceDialog.data.switches" :key="index" class="switch-card">
                            <div class="row items-center q-mb-sm">
                                <div class="col text-caption text-weight-medium">Switch {% raw %}{{ index + 1 }}{% endraw %}</div>
                                <div class="col-auto q-gutter-x-xs">
                                    <!-- QR Code button - only for saved switches -->
                                    <q-btn
                                        v-if="sw.id && sw.lnurl"
                                        flat
                                        dense
                                        round
                                        size="sm"
                                        @click="openSwitchQrCode(deviceDialog.data, sw)"
                                        :disable="protocol === 'http:'"
                                        class="q-pa-xs"
                                    >
                                        <img
                                            src="{{ static_url_for('devicetimer/static', path='image/qrcode_icon.png') }}"
                                            style="width: 24px; height: 24px;"
                                        >
                                        <q-tooltip>Show QR Code</q-tooltip>
                                    </q-btn>
                                    <!-- Copy LNURL button -->
                                    <q-btn
                                        v-if="sw.id && sw.lnurl"
                                        flat
                                        dense
                                        round
                                        size="xs"
                                        color="grey-7"
                                        @click="copyText(sw.lnurl, 'LNURL copied')"
                                    >
                                        <q-icon size="16px">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24">
                                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                                    <path d="M7 9.667A2.667 2.667 0 0 1 9.667 7h8.666A2.667 2.667 0 0 1 21 9.667v8.666A2.667 2.667 0 0 1 18.333 21H9.667A2.667 2.667 0 0 1 7 18.333z"/>
                                                    <path d="M4.012 16.737A2 2 0 0 1 3 15V5c0-1.1.9-2 2-2h10c.75 0 1.158.385 1.5 1"/>
                                                </g>
                                            </svg>
                                        </q-icon>
                                        <q-tooltip>Copy LNURL</q-tooltip>
                                    </q-btn>
                                    <q-btn flat dense round size="xs" color="red-7" icon="close" @click="removeSwitch(index)">
                                        <q-tooltip>Remove</q-tooltip>
                                    </q-btn>
                                </div>
                            </div>
                            <div class="row q-col-gutter-sm">
                                <div class="col-6">
                                    <q-input
                                        v-model.number="sw.amount"
                                        type="number"
                                        filled
                                        dense
                                        :label="'Amount (' + deviceDialog.data.currency + ')'"
                                    ></q-input>
                                </div>
                                <div class="col-6">
                                    <q-input v-model="sw.label" filled dense label="Label"></q-input>
                                </div>
                                <div class="col-6">
                                    <q-input v-model.number="sw.gpio_pin" type="number" filled dense label="GPIO Pin"></q-input>
                                </div>
                                <div class="col-6">
                                    <q-input v-model.number="sw.gpio_duration" type="number" filled dense label="Duration (ms)"></q-input>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="row items-center q-mt-lg q-pt-sm">
                        <q-btn
                            unelevated
                            color="primary"
                            type="submit"
                            :label="deviceDialog.isEdit ? 'Update' : 'Create'"
                            :disable="!deviceDialog.data.title"
                            class="avatar_style"
                            no-caps
                        ></q-btn>
                        <q-space></q-space>
                        <q-btn flat color="grey-7" @click="deviceDialog.show = false" no-caps>Cancel</q-btn>
                    </div>
                </q-form>
            </q-card-section>
        </q-card>
    </q-dialog>

    <!-- QR Code Dialog -->
    <q-dialog v-model="qrCodeDialog.show" @hide="disconnectWebsocket">
        <q-card v-if="qrCodeDialog.data" class="dialog_style" style="width: 420px; max-width: 95vw;">
            <!-- Header -->
            <q-card-section class="q-pb-none">
                <div class="row items-center no-wrap">
                    <div class="col">
                        <div class="text-h6">{% raw %}{{ qrCodeDialog.data.title }}{% endraw %}</div>
                        <div class="text-caption text-grey">Scan with a Lightning wallet</div>
                    </div>
                    <div class="col-auto">
                        <q-btn flat round dense size="sm" @click="closeQrCodeDialog">
                            <q-icon name="close" size="20px"></q-icon>
                        </q-btn>
                    </div>
                </div>
            </q-card-section>

            <!-- Switch Selector -->
            <q-card-section v-if="qrCodeDialog.data.switches.length > 1" class="q-pt-md q-pb-none">
                <div class="text-caption text-weight-medium text-grey-7 q-mb-sm">Select Switch</div>
                <div class="row q-gutter-sm">
                    <q-btn
                        v-for="sw in qrCodeDialog.data.switches"
                        :key="sw.id"
                        :outline="qrCodeDialog.selectedSwitch?.id !== sw.id"
                        :unelevated="qrCodeDialog.selectedSwitch?.id === sw.id"
                        color="primary"
                        size="md"
                        :label="sw.label || 'Switch'"
                        @click="selectSwitch(sw)"
                        class="avatar_style"
                        no-caps
                    ></q-btn>
                </div>
            </q-card-section>

            <!-- QR Code -->
            <q-card-section class="q-pt-md text-center">
                <div class="qr-wrapper">
                    <img :src="qrcodeUrl" class="qr-image">
                </div>

                <!-- Switch Info -->
                <div v-if="qrCodeDialog.selectedSwitch" class="q-mt-md">
                    <q-badge color="primary" class="q-px-sm q-py-xs text-body2">
                        {% raw %}{{ qrCodeDialog.selectedSwitch.amount }}{% endraw %} {% raw %}{{ qrCodeDialog.data.currency }}{% endraw %}
                    </q-badge>
                </div>

                <!-- WebSocket Status -->
                <div class="q-mt-sm">
                    <q-chip
                        :color="websocketMessage.includes('connected') ? 'positive' : websocketMessage.includes('Payment') ? 'positive' : 'grey-6'"
                        text-color="white"
                        size="sm"
                        :icon="websocketMessage.includes('connected') ? 'wifi' : websocketMessage.includes('Payment') ? 'check_circle' : 'wifi_off'"
                    >
                        {% raw %}{{ wsMessage }}{% endraw %}
                    </q-chip>
                </div>
            </q-card-section>

            <!-- LNURL Display -->
            <q-card-section class="q-pt-none">
                <div class="lnurl-box">
                    <div class="text-caption text-grey-6 q-mb-xs">LNURL</div>
                    <div class="lnurl-value">{% raw %}{{ lnurlValue }}{% endraw %}</div>
                </div>
            </q-card-section>

            <!-- Actions -->
            <q-card-actions class="q-px-md q-pb-md q-pt-none">
                <q-btn unelevated color="primary" class="avatar_style" @click="copyText(lnurlValue, 'LNURL copied!')" no-caps>
                    <q-icon name="content_copy" size="18px" class="q-mr-sm"></q-icon>
                    Copy LNURL
                </q-btn>
                <q-space></q-space>
                <q-btn flat color="grey-7" @click="closeQrCodeDialog" no-caps>Close</q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <!-- Delete Confirmation Dialog -->
    <q-dialog v-model="deleteDialog.show">
        <q-card class="dialog_style" style="width: 400px; max-width: 95vw;">
            <q-card-section class="q-pb-none">
                <div class="row items-center no-wrap">
                    <q-avatar size="42px" color="red-1" text-color="red" class="avatar_style">
                        <q-icon name="delete_outline" size="24px"></q-icon>
                    </q-avatar>
                    <div class="q-ml-md col">
                        <div class="text-h6">Delete Device</div>
                        <div class="text-caption text-grey">This action cannot be undone</div>
                    </div>
                </div>
            </q-card-section>

            <q-card-section>
                <p class="q-mb-sm text-body2">
                    Are you sure you want to delete <strong>"{% raw %}{{ deleteDialog.deviceTitle }}{% endraw %}"</strong>?
                </p>
                <p class="text-caption text-grey q-mb-none" v-if="deleteDialog.switchCount > 0">
                    This will remove {% raw %}{{ deleteDialog.switchCount }}{% endraw %} switch{% raw %}{{ deleteDialog.switchCount > 1 ? 'es' : '' }}{% endraw %} and their LNURL configurations.
                </p>

                <q-banner class="bg-red-1 text-red-9 q-mt-md" rounded dense>
                    <template v-slot:avatar>
                        <q-icon name="warning" color="red" size="sm"></q-icon>
                    </template>
                    <span class="text-caption">
                        This action will break any connected hardware device. A new setup will be required for that device.
                    </span>
                </q-banner>
            </q-card-section>

            <q-card-actions class="q-px-md q-pb-md q-pt-none">
                <q-btn flat color="grey-7" v-close-popup no-caps>Cancel</q-btn>
                <q-space></q-space>
                <q-btn unelevated color="red" class="avatar_style" @click="confirmDeleteDevice" no-caps>
                    <q-icon name="delete" size="18px" class="q-mr-sm"></q-icon>
                    Delete
                </q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <!-- WebSocket Dialog -->
    <q-dialog v-model="websocketDialog.show">
        <q-card class="dialog_style" style="width: 480px; max-width: 95vw;">
            <q-card-section>
                <div class="row items-center no-wrap q-mb-md">
                    <q-avatar size="42px" color="primary" text-color="white" class="avatar_style">
                        <q-icon size="24px">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                                    <path d="M12 18v-6"/>
                                    <path d="M8 18v-2"/>
                                    <path d="M16 18v-4"/>
                                    <path d="M6 12a6 6 0 0 1 12 0"/>
                                    <path d="M3 9a10 10 0 0 1 18 0"/>
                                </g>
                            </svg>
                        </q-icon>
                    </q-avatar>
                    <div class="q-ml-md col">
                        <div class="text-h6">Device Connection</div>
                        <div class="text-caption text-grey">Hardware configuration</div>
                    </div>
                    <q-btn flat round dense size="sm" v-close-popup>
                        <q-icon name="close" size="20px"></q-icon>
                    </q-btn>
                </div>

                <q-banner class="bg-blue-1 text-blue-9 q-mb-md" rounded>
                    <template v-slot:avatar>
                        <q-icon name="info" color="primary"></q-icon>
                    </template>
                    Use this WebSocket URL in your bitcoinSwitch device configuration to receive real-time payment notifications.
                </q-banner>

                <div class="text-caption text-weight-medium text-grey-7 q-mb-xs">WebSocket URL</div>
                <div class="ws-url-box">
                    <code class="ws-url-value">{% raw %}{{ websocketDialog.url }}{% endraw %}</code>
                </div>

                <div class="text-caption text-grey q-mt-md">
                    <strong>Device:</strong> {% raw %}{{ websocketDialog.deviceTitle }}{% endraw %}
                </div>
            </q-card-section>

            <q-card-actions class="q-px-md q-pb-md q-pt-none">
                <q-btn unelevated color="primary" class="avatar_style" @click="copyText(websocketDialog.url, 'WebSocket URL copied!')" no-caps>
                    <q-icon name="content_copy" size="18px" class="q-mr-sm"></q-icon>
                    Copy URL
                </q-btn>
                <q-space></q-space>
                <q-btn flat color="grey-7" v-close-popup no-caps>Close</q-btn>
            </q-card-actions>
        </q-card>
    </q-dialog>

    <!-- Donation Dialog -->
    <q-dialog v-model="donationDialog.show">
        <q-card class="dialog_style" style="width: 360px; max-width: 95vw;">
            <!-- Header -->
            <q-card-section class="q-pb-none text-center">
                <q-btn flat round dense size="sm" v-close-popup class="absolute-top-right q-ma-sm">
                    <q-icon name="close" size="18px" color="grey-6"></q-icon>
                </q-btn>
                <div class="text-h6 q-mb-xs">Support DeviceTimer</div>
                <div class="text-caption text-grey">Open source powered by sats</div>
            </q-card-section>

            <!-- QR Code -->
            <q-card-section class="text-center q-py-md">
                <div class="qr-wrapper q-mx-auto" style="padding: 16px;">
                    <img :src="getDonationQrUrl()" style="width: 160px; height: 160px; display: block;">
                </div>
                <div
                    class="text-caption q-mt-sm q-px-md text-grey-6"
                    style="font-family: monospace; font-size: 0.7rem; cursor: pointer;"
                    @click="copyText(donationDialog.address, 'Copied!')"
                >
                    {% raw %}{{ donationDialog.address }}{% endraw %}
                    <q-icon name="content_copy" size="12px" class="q-ml-xs"></q-icon>
                </div>
            </q-card-section>

            <!-- Amount Selection -->
            <q-card-section class="q-pt-none">
                <!-- Tier Buttons -->
                <div class="row q-col-gutter-xs q-mb-sm">
                    <div class="col-3" v-for="tier in donationDialog.tiers" :key="tier.amount">
                        <q-btn
                            :outline="donationDialog.selectedTier?.amount !== tier.amount"
                            :unelevated="donationDialog.selectedTier?.amount === tier.amount"
                            :color="donationDialog.selectedTier?.amount === tier.amount ? 'primary' : 'grey-7'"
                            dense
                            no-caps
                            class="full-width"
                            style="border-radius: 6px; font-size: 0.75rem;"
                            @click="selectDonationTier(tier)"
                        >
                            {% raw %}{{ formatSats(tier.amount) }}{% endraw %}
                        </q-btn>
                    </div>
                </div>

                <!-- Custom Input -->
                <q-input
                    v-model.number="donationDialog.customAmount"
                    type="number"
                    outlined
                    dense
                    placeholder="Custom amount"
                    @focus="selectCustomAmount"
                    class="q-mb-sm"
                    style="font-size: 0.85rem;"
                    :input-style="{ textAlign: 'center' }"
                >
                    <template v-slot:append>
                        <span class="text-grey-6" style="font-size: 0.8rem;">sats</span>
                    </template>
                </q-input>

                <!-- Description -->
                <div
                    v-if="donationDialog.selectedTier"
                    class="text-center q-pa-sm"
                    style="background: rgba(128,128,128,0.06); border-radius: 6px;"
                >
                    <q-icon :name="donationDialog.selectedTier.icon" size="16px" color="primary" class="q-mr-xs"></q-icon>
                    <span class="text-caption text-grey-8">{% raw %}{{ donationDialog.selectedTier.label }}{% endraw %}</span>
                    <div class="text-caption text-grey-6 q-mt-xs" style="font-size: 0.7rem;">
                        {% raw %}{{ donationDialog.selectedTier.description }}{% endraw %}
                    </div>
                </div>
            </q-card-section>

            <!-- Footer -->
            <q-card-section class="q-pt-none text-center">
                <div class="text-caption text-grey-5" style="font-size: 0.65rem;">
                    Scan QR or copy address  Thank you for supporting open source
                </div>
            </q-card-section>
        </q-card>
    </q-dialog>

</div>
{% endblock %}
